name: PR Bot

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  bot-commands:
    # åªåœ¨PRè¯„è®ºä¸­è§¦å‘
    if: github.event.issue.pull_request != null
    runs-on: ubuntu-latest

    steps:
      - name: æ£€æŸ¥å‘½ä»¤
        id: check-command
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.toLowerCase().trim();
            const commands = {
              merge: comment.includes('@bot merge') || comment.includes('@æœºå™¨äºº åˆå¹¶'),
              review: comment.includes('@bot review') || comment.includes('@æœºå™¨äºº review'),
              approve: comment.includes('@bot approve') || comment.includes('@æœºå™¨äºº æ‰¹å‡†'),
              close: comment.includes('@bot close') || comment.includes('@æœºå™¨äºº å…³é—­'),
              reopen: comment.includes('@bot reopen') || comment.includes('@æœºå™¨äºº é‡å¼€'),
              help: comment.includes('@bot help') || comment.includes('@æœºå™¨äºº å¸®åŠ©')
            };

            core.setOutput('merge', commands.merge);
            core.setOutput('review', commands.review);
            core.setOutput('approve', commands.approve);
            core.setOutput('close', commands.close);
            core.setOutput('reopen', commands.reopen);
            core.setOutput('help', commands.help);

            return commands;

      - name: è·å–PRä¿¡æ¯
        id: pr-info
        if: steps.check-command.outputs.merge == 'true' || steps.check-command.outputs.review == 'true' || steps.check-command.outputs.approve == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            core.setOutput('mergeable', pr.mergeable);
            core.setOutput('state', pr.state);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('head_ref', pr.head.ref);

            return pr;

      - name: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
        if: steps.check-command.outputs.help == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const helpMessage = [
              '## ğŸ¤– PR Bot å¸®åŠ©',
              '',
              'å¯ç”¨å‘½ä»¤',
              '',
              '- `@bot merge` æˆ– `@æœºå™¨äºº åˆå¹¶` - è‡ªåŠ¨åˆå¹¶å½“å‰PRï¼ˆéœ€è¦é€šè¿‡CIæ£€æŸ¥ï¼‰',
              '- `@bot review` æˆ– `@æœºå™¨äºº review` - è¯·æ±‚ä»£ç review',
              '- `@bot approve` æˆ– `@æœºå™¨äºº æ‰¹å‡†` - æ‰¹å‡†å½“å‰PR',
              '- `@bot close` æˆ– `@æœºå™¨äºº å…³é—­` - å…³é—­å½“å‰PR',
              '- `@bot reopen` æˆ– `@æœºå™¨äºº é‡å¼€` - é‡æ–°æ‰“å¼€PR',
              '- `@bot help` æˆ– `@æœºå™¨äºº å¸®åŠ©` - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯',
              '',
              '**æ³¨æ„**',
              '- åˆå¹¶æ“ä½œä¼šæ£€æŸ¥CIçŠ¶æ€ï¼Œåªæœ‰æ‰€æœ‰æ£€æŸ¥é€šè¿‡æ‰ä¼šåˆå¹¶',
              '- åªæœ‰ä»“åº“åä½œè€…å’Œç»´æŠ¤è€…å¯ä»¥æ‰§è¡Œè¿™äº›å‘½ä»¤'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: helpMessage
            });

      - name: Checkoutä»£ç 
        if: steps.check-command.outputs.review == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.pr-info.outputs.head_ref }}

      - name: æ‰§è¡Œä»£ç Review
        if: steps.check-command.outputs.review == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // è·å–PRçš„æ–‡ä»¶å˜æ›´
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // æ·»åŠ reviewè¯„è®º
            const reviewComments = [];

            for (const file of files) {
              // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„reviewé€»è¾‘
              // ä¾‹å¦‚æ£€æŸ¥ä»£ç é£æ ¼ã€å®‰å…¨é—®é¢˜ç­‰

              // ç¤ºä¾‹ï¼šæ£€æŸ¥æ˜¯å¦æœ‰console.logï¼ˆä»…ä¾›å‚è€ƒï¼‰
              if (file.filename.endsWith('.js') || file.filename.endsWith('.ts') || file.filename.endsWith('.vue')) {
                if (file.patch && file.patch.includes('console.log')) {
                  reviewComments.push({
                    path: file.filename,
                    body: 'âš ï¸ å‘ç° `console.log` è¯­å¥ï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç§»é™¤ã€‚',
                    line: 1 // è¿™é‡Œåº”è¯¥è®¡ç®—å®é™…è¡Œå·
                  });
                }
              }
            }

            // åˆ›å»ºreview
            let reviewBody = '## ğŸ¤– è‡ªåŠ¨ä»£ç Review\n\n';
            reviewBody += `å·²æ£€æŸ¥ ${files.length} ä¸ªæ–‡ä»¶çš„å˜æ›´ã€‚\n\n`;

            if (reviewComments.length > 0) {
              reviewBody += '### å‘ç°ä»¥ä¸‹å»ºè®®ï¼š\n';
              reviewComments.forEach(comment => {
                reviewBody += `- **${comment.path}**: ${comment.body}\n`;
              });
            } else {
              reviewBody += 'âœ… æœªå‘ç°æ˜æ˜¾é—®é¢˜ï¼Œä»£ç çœ‹èµ·æ¥ä¸é”™ï¼\n';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewBody
            });

      - name: æ‰¹å‡†PR
        if: steps.check-command.outputs.approve == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'âœ… æœºå™¨äººè‡ªåŠ¨æ‰¹å‡†æ­¤PR'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âœ… PRå·²è¢«æ‰¹å‡†ï¼'
            });

      - name: æ£€æŸ¥CIçŠ¶æ€
        if: steps.check-command.outputs.merge == 'true'
        id: check-ci
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: '${{ steps.pr-info.outputs.head_sha }}'
            });

            const failedChecks = checks.check_runs.filter(
              check => check.status === 'completed' && check.conclusion !== 'success' && check.conclusion !== 'skipped'
            );

            if (failedChecks.length > 0) {
              const failedNames = failedChecks.map(c => c.name).join(', ');
              core.setOutput('ci_passed', 'false');
              core.setOutput('failed_checks', failedNames);
            } else {
              core.setOutput('ci_passed', 'true');
            }

      - name: åˆå¹¶PR
        if: steps.check-command.outputs.merge == 'true' && steps.check-ci.outputs.ci_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'merge', // å¯é€‰: 'merge', 'squash', 'rebase'
                commit_message: 'ğŸ¤– æœºå™¨äººè‡ªåŠ¨åˆå¹¶'
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âœ… PRå·²æˆåŠŸåˆå¹¶ï¼'
              });
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ åˆå¹¶å¤±è´¥ï¼š${error.message}`
              });
              throw error;
            }

      - name: CIæ£€æŸ¥å¤±è´¥æç¤º
        if: steps.check-command.outputs.merge == 'true' && steps.check-ci.outputs.ci_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âŒ æ— æ³•åˆå¹¶ï¼šä»¥ä¸‹CIæ£€æŸ¥æœªé€šè¿‡ï¼š\n\n${context.payload.failed_checks || 'éƒ¨åˆ†æ£€æŸ¥å¤±è´¥'}\n\nè¯·å…ˆä¿®å¤è¿™äº›é—®é¢˜åå†å°è¯•åˆå¹¶ã€‚`
            });

      - name: å…³é—­PR
        if: steps.check-command.outputs.close == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'closed'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ğŸ”’ PRå·²å…³é—­'
            });

      - name: é‡æ–°æ‰“å¼€PR
        if: steps.check-command.outputs.reopen == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'open'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ğŸ”“ PRå·²é‡æ–°æ‰“å¼€'
            });
